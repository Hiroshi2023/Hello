name: CI/CD Pipeline for Heart Disease Model

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # NOUVEAU : On d√©finit une variable d'environnement pour le job
    # Ceci est la cl√© pour r√©soudre le probl√®me.
    env:
      THRESHOLD: ${{ secrets.THRESHOLD_SCORE }}

    steps:

      - name: üîß D√©finir PYTHONPATH
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pdoc script/model_training.py script/model_evaluation.py script/deploy_model.py -o site/docs

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train model
        run: python script/model_training.py

      - name: Evaluate model
        id: evaluate
        run: |
          python script/model_evaluation.py
          SCORE=$(jq .accuracy metrics/metrics.json)
          echo "Model Score is: $SCORE"
          echo "score=$SCORE" >> $GITHUB_OUTPUT

      # --- BLOC DE D√âPLOIEMENT ---
      - name: Deploy to Hugging Face Hub
        # CORRIG√â : On compare maintenant avec env.THRESHOLD
        # Notez l'absence de ${{...}} car c'est une condition if
        if: steps.evaluate.outputs.score >= env.THRESHOLD
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: python script/deploy.py
      
      # --- BLOC DE G√âN√âRATION DU SITE ---
      - name: Generate static site for results (Deployment Case)
        # CORRIG√â : On compare avec env.THRESHOLD
        if: steps.evaluate.outputs.score >= env.THRESHOLD
        run: |
          mkdir -p site
          echo "<html><body>" > site/index.html
          echo "<h1>R√©sultats du Mod√®le de Diamond</h1>" >> site/index.html
          echo "<h2>Statut : D√âPLOY√â AVEC SUCC√àS</h2>" >> site/index.html
          echo "<p>Derni√®re mise √† jour : $(date)</p>" >> site/index.html
          echo "<h3>Score d'Accuracy : ${{ steps.evaluate.outputs.score }} (Seuil : ${{ env.THRESHOLD }})</h3>" >> site/index.html
          echo "<p>Le mod√®le a √©t√© d√©ploy√© car le score est sup√©rieur ou √©gal au seuil.</p>" >> site/index.html
          echo "<p>Lien vers le mod√®le sur Hugging Face : <a href='https://huggingface.co/Hiroshi99/diamond-model'>Voir le mod√®le</a></p>" >> site/index.html
          echo "<p><a href='docs/index.html'>Voir la documentation technique du projet</a></p>" >> site/index.html
          echo "</body></html>" >> site/index.html

      - name: Generate static site for results (Non-Deployment Case)
        # CORRIG√â : On compare avec env.THRESHOLD
        if: steps.evaluate.outputs.score < env.THRESHOLD
        run: |
          mkdir -p site
          echo "<html><body>" > site/index.html
          echo "<h1>R√©sultats du Mod√®le de Pr√©diction Cardiaque</h1>" >> site/index.html
          echo "<h2>Statut : D√âPLOIEMENT REFUS√â</h2>" >> site/index.html
          echo "<p>Derni√®re mise √† jour : $(date)</p>" >> site/index.html
          echo "<h3>Score d'Accuracy : ${{ steps.evaluate.outputs.score }} (Seuil Requis : ${{ env.THRESHOLD }})</h3>" >> site/index.html
          echo "<p>Le mod√®le n'a pas √©t√© d√©ploy√© car le score est inf√©rieur au seuil requis.</p>" >> site/index.html
          echo "<p><a href='docs/index.html'>Voir la documentation technique du projet</a></p>" >> site/index.html
          echo "</body></html>" >> site/index.html
          
      - name: Generate Technical Documentation
        if: success()
        run: pdoc script/model_training.py script/model_evaluation.py script/deploy.py -o site/docs
          
      - name: Deploy to GitHub Pages
        if: success()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: site
          
      # --- BLOC DE NOTIFICATIONS (ADAPT√â) ---
      - name: Send success email notification (Deployment)
        # CORRIG√â : On compare avec env.THRESHOLD
        if: success() && steps.evaluate.outputs.score >= env.THRESHOLD
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "‚úÖ [SUCC√àS] D√©ploiement du mod√®le diamond"
          body: |
            Bonjour,
            Le mod√®le a √©t√© valid√© et d√©ploy√© avec succ√®s.
            Score d'accuracy obtenu : ${{ steps.evaluate.outputs.score }} (Seuil : ${{ env.THRESHOLD }})
            Commit par : ${{ github.actor }}
            Lien vers les logs : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }},${{ github.event.pusher.email }}
          from: GitHub Actions Notifier <${{ secrets.SMTP_USER }}>

      - name: Send failure email notification (Low Score)
        # CORRIG√â : On compare avec env.THRESHOLD
        if: success() && steps.evaluate.outputs.score < env.THRESHOLD
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "‚Ñπ [INFO] Non-d√©ploiement du mod√®le (Score trop bas)"
          body: |
            Bonjour,
            La validation a r√©ussi, mais le score est trop bas pour un d√©ploiement.
            Score d'accuracy obtenu : ${{ steps.evaluate.outputs.score }} (Seuil requis : ${{ env.THRESHOLD }})
            Commit par : ${{ github.actor }}
            Lien vers les logs : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }},${{ github.event.pusher.email }}
          from: GitHub Actions Notifier <${{ secrets.SMTP_USER }}>

      - name: Send failure email notification (Job Failed)
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "‚ùå [√âCHEC] Le workflow CI/CD a √©chou√©"
          body: |
            Bonjour,
            Le workflow a √©chou√© en raison d'une erreur.
            Merci de consulter les logs.
            Commit par : ${{ github.actor }}
            Lien vers les logs : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.ADMIN_EMAIL }},${{ github.event.pusher.email }}
          from: GitHub Actions Notifier <${{ secrets.SMTP_USER¬†}}>
